<!-- app/templates/login.html -->
{% extends "base.html" %} <!-- Указываем, что наследуем base.html -->

{% block title %}Login - w3tasq{% endblock %} <!-- Переопределяем заголовок -->

{% block content %} <!-- Заполняем блок content -->
<div class="login-container">
    <h2>Connect Your Wallet</h2>
    <p>Please connect your Web3 wallet to access the application.</p>
    <button id="connectWallet" class="btn">Connect Wallet</button>
    <div id="status" style="margin-top: 15px;"></div>
</div>

{% block extra_scripts %}
<!-- Сюда можно добавить специфичный JS для страницы логина, если он был -->
<script>
        // Check if MetaMask is available
        function checkWalletConnection() {
            const statusElement = document.getElementById('status');
            
            if (typeof window.ethereum === 'undefined') {
                statusElement.innerHTML = '<p style="color: red;">MetaMask is not installed. Please install it to continue.</p>';
                return false;
            }
            
            statusElement.innerHTML = '<p style="color: green;">MetaMask detected! Ready to connect.</p>';
            return true;
        }
        
        // Connect to wallet
        async function connectWallet() {
            const statusElement = document.getElementById('status');
            statusElement.innerHTML = '<p>Connecting to wallet...</p>';
            
            try {
                // Request account access
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                const address = accounts[0];
                statusElement.innerHTML = `<p>Connected: ${address}</p>`;
                
                // Get challenge from server
                const challengeResponse = await fetch('/api/auth/challenge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ address: address })
                });
                
                const challengeData = await challengeResponse.json();
                
                if (!challengeData.success) {
                    throw new Error(challengeData.error || 'Failed to get challenge');
                }
                
                const message = challengeData.message;
                
                // Sign the message with the wallet
                const signature = await window.ethereum.request({
                    method: 'personal_sign',
                    params: [message, address]
                });
                
                // Verify signature with server
                const verifyResponse = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        address: address,
                        signature: signature
                    })
                });
                
                const verifyData = await verifyResponse.json();
                
                if (verifyData.success) {
                    statusElement.innerHTML += '<p style="color: green;">✅ Authentication successful!</p>';
                    // Redirect to main page
                    window.location.href = '/';
                } else {
                    statusElement.innerHTML += `<p style="color: red;">❌ ${verifyData.error}</p>`;
                }
                
            } catch (error) {
                statusElement.innerHTML += `<p style="color: red;">❌ ${error.message}</p>`;
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const connectButton = document.getElementById('connectWallet');
            
            // Check wallet connection on page load
            checkWalletConnection();
            
            // Set up button click handler
            if (connectButton) {
                connectButton.addEventListener('click', connectWallet);
            }
        });
    </script>
{% endblock %}

{% endblock %} <!-- Закрываем блок content -->